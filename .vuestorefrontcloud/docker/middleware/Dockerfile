FROM node:20-alpine

ARG NODE_AUTH_TOKEN

ARG NPM_USER
ARG NPM_PASS
ARG NPM_EMAIL
ARG NPM_REGISTRY
ARG CNTF_SPACE
ARG CNTF_TOKEN
ARG CNTF_BRANCH
ARG SAPCC_OAUTH_URI
ARG SAPCC_OAUTH_CLIENT_ID
ARG SAPCC_OAUTH_CLIENT_SECRET
ARG SAPCC_OAUTH_TOKEN_ENDPOINT
ARG SAPCC_OAUTH_TOKEN_REVOKE_ENDPOINT
ARG SAPCC_API_URI
ARG SAPCC_MEDIA_HOST
ARG DEFAULT_BASE_SITE_ID
ARG DEFAULT_CATALOG_ID
ARG DEFAULT_CATALOG_VERSION
ARG DEFAULT_LANGUAGE
ARG DEFAULT_CURRENCY

ENV NODE_AUTH_TOKEN=${NODE_AUTH_TOKEN}

ENV CNTF_SPACE=${CNTF_SPACE}
ENV CNTF_TOKEN=${CNTF_TOKEN}
ENV CNTF_BRANCH=${CNTF_BRANCH}
ENV SAPCC_OAUTH_URI=${SAPCC_OAUTH_URI}
ENV SAPCC_OAUTH_CLIENT_ID=${SAPCC_OAUTH_CLIENT_ID}
ENV SAPCC_OAUTH_CLIENT_SECRET=${SAPCC_OAUTH_CLIENT_SECRET}
ENV SAPCC_OAUTH_TOKEN_ENDPOINT=${SAPCC_OAUTH_TOKEN_ENDPOINT}
ENV SAPCC_OAUTH_TOKEN_REVOKE_ENDPOINT=${SAPCC_OAUTH_TOKEN_REVOKE_ENDPOINT}
ENV SAPCC_API_URI=${SAPCC_API_URI}
ENV SAPCC_MEDIA_HOST=${SAPCC_MEDIA_HOST}
ENV DEFAULT_BASE_SITE_ID=${DEFAULT_BASE_SITE_ID}
ENV DEFAULT_CATALOG_ID=${DEFAULT_CATALOG_ID}
ENV DEFAULT_CATALOG_VERSION=${DEFAULT_CATALOG_VERSION}
ENV DEFAULT_LANGUAGE=${DEFAULT_LANGUAGE}
ENV DEFAULT_CURRENCY=${DEFAULT_CURRENCY}

WORKDIR /var/www

COPY . .

RUN apk add --no-cache libc6-compat

RUN npm install -g npm-cli-login && npm-cli-login

RUN yarn install
RUN yarn turbo run build --scope="server"

COPY .vuestorefrontcloud/docker/middleware/middleware.sh /usr/local/bin/

RUN chmod a+x /usr/local/bin/middleware.sh

ENTRYPOINT ["middleware.sh"]
